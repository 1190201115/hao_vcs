<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>工作台</title>
    <script src="../js/outService.js"></script>
    <script src="../plugins/router/vue-router.global.js"></script>
    <script src="../js/sortProject.js"></script>
</head>
<body>
<div id="app" style=" margin:0 auto;">

    <el-col :span="4">
        <el-menu
                default-active="depot"
                @select="handleSelect">
            <el-menu-item index="depot">
                <span slot="title">仓库</span>
            </el-menu-item>
            <el-menu-item index="myLike">
                <span slot="title">我的收藏</span>
            </el-menu-item>
            <el-menu-item index="addProject">
                <span slot="title">新建工程</span>
            </el-menu-item>
        </el-menu>
    </el-col>
    <div v-show="showDepot">
        <el-col :span="20">
            <el-menu default-active="all" class="el-menu-demo" mode="horizontal" @select="handleClick">
                <el-menu-item index="all">全部</el-menu-item>
                <el-menu-item index="ownPro">拥有项目</el-menu-item>
                <el-menu-item index="joinPro">参与项目</el-menu-item>
                <el-submenu index="sort" style="margin-right: 20%">
                    <template slot="title">排序</template>
                    <el-menu-item index="publicFirst">公开在前</el-menu-item>
                    <el-menu-item index="privateFirst">私有在前</el-menu-item>
                    <el-menu-item index="latestFirst">最新在前</el-menu-item>
                    <el-menu-item index="reverse">反转</el-menu-item>
                </el-submenu>
            </el-menu>

            <div v-show="showProjectList">
                <ul style="overflow:auto;width: 75%">
                    <li v-for="(project,i) in projectList" class="infinite-list-item" style="list-style:none">
                        <el-card class="box-card" @click.native="getResearch()">
                            <div slot="header" class="clearfix">
                                <span>{{ project.projectName }}</span>
                                <el-button style="float: right; padding: 3px 0" type="text"
                                           @click="checkProject(project)">进入项目
                                </el-button>
                            </div>
                            <span style=" color: #9f9f9f; font-size: small;">创建时间: {{ project.createTime }}</span>
                            <span v-if="project.privacy==1" style=" color: #3a9edc; font-size: small;float: right;">公开</span>
                            <span v-if="project.privacy==0" style=" color: #e57161; font-size: small;float: right;">私有</span>
                        </el-card>
                        <p></p>
                    </li>
                </ul>
            </div>
            <div v-show="!showProjectList">
                <p style="text-align: center;margin-top: 20%; color: #9f9f9f; font-size: xx-large;">
                    还没有任何工程哦~</p>
            </div>

        </el-col>
    </div>
    <div v-show="showMyLike">
        showMyLike
    </div>
    <div v-show="showAddProject">
        <el-col :span="20">
            <iframe id="newProjectIframe" src="../page/new_project.html"
                    style="border: medium none;width: 100%;height: 750px"></iframe>
        </el-col>
    </div>
    <div v-show="showProject">
        <el-container>
            <el-header style="height: 100px; background-color: #f3f5f5">
                <br>
                <span style="margin-left: 20px; font-size: large; font-weight: bold">
                        <i class="el-icon-s-cooperation"></i>
                        {{selectedProject.projectName}}</span>
                <el-tabs value="projectContent" @tab-click="tabAlt" style="margin-left: 20px;margin-top: 14px">
                    <el-tab-pane name="projectContent">
                            <span slot="label"
                                  @click=""><i class="el-icon-folder-opened"></i> 项目内容</span>
                    </el-tab-pane>
                    <el-tab-pane name="projectSettings">
                        <span slot="label"><i class="el-icon-setting"></i> 配置管理</span>
                    </el-tab-pane>
                </el-tabs>
            </el-header>
            <el-main>
                <div v-show="showProjectContent">
                    <div style="height: 50px">
                        <el-button @click="uploadFileVisible = true">上传文件</el-button>
                        <el-button @click="downloadProject">下载工程</el-button>
                    </div>
                    <el-dialog title="文件上传" :visible.sync="uploadFileVisible">
                        <iframe id="uploadFIlle" src= "./uploadFile.html"
                                style="border: medium none;height: 100%; width: 100%;"></iframe>
                    </el-dialog>
                    <el-card class="project-card">
                        <div slot="header">
                            <span>{{latestProjectChangeImf.latestActor}}</span>
                            <span style="color: #8db2f6; margin-left: 1%;">{{latestProjectChangeImf.latestAction}}</span>
                            <span style="font-size: small;margin-left: 1%;color: #8c939d">
                            {{latestProjectChangeImf.latestUpdateTime}}</span>
                        </div>
                        <div>
                            projectImf
                        </div>
                    </el-card>
                </div>
                <div v-show="showProjectSettings">
                    <el-button type="danger"  @click="deleteProject">删除项目</el-button>
                </div>
            </el-main>
            <el-footer>
                <div v-show="showProjectContent">
                    <el-card class="project-des-card">
                        <div slot="header">
                            <span style="font-size: larger">工程简介</span>
                        </div>
                        <div>
                            {{selectedProject.description}}
                        </div>
                    </el-card>
                </div>
            </el-footer>
        </el-container>
    </div>

</div>
<script>
    let vm = new Vue({
        el: "#app",
        data() {
            return {
                showDepot: true,
                showMyLike: false,
                showAddProject: false,
                showProjectList: true,
                showProject: false,
                showProjectContent: true,
                showProjectSettings: false,
                uploadFileVisible: false,
                projectList: [
                    {projectName: "p1", description: "this is 1", privacy: 0, createTime: '2023-02-09 20:46:27'},
                    {projectName: "p2", description: "this is 2", privacy: 1, createTime: '2023-02-10 20:46:20'},
                    {projectName: "p3", description: "this is 3", privacy: 1, createTime: '2023-02-08 20:46:00'},
                ],
                selectedProject: {},
                latestProjectChangeImf: {latestActor: "cyh?", latestAction: "nothing?", latestUpdateTime: "now?"}
            }
        },
        mounted() {
            window.addEventListener('message', this.handleMessage)
            this.getAllProject()
        },
        methods: {
            deleteProject(){
                this.$confirm('此操作将永久删除该文件, 是否继续?', '提示', {
                    confirmButtonText: '确定',
                    cancelButtonText: '取消',
                    type: 'warning'
                }).then(() => {
                    axios.delete('/project/deleteProject', {params: {'projectId': this.selectedProject.projectId}})
                        .then(results => {
                            if (results.data.code === 20000) {
                                this.$message.success('删除成功!')
                                this.handleSelect('depot')
                            } else {
                                this.$message.error('删除失败!')
                            }
                            this.getAllProject()
                        })
                }).catch(() => {
                    this.$message({
                        type: 'info',
                        message: '已取消删除'
                    });
                });
            },
            tabAlt(tab) {
                let choice = tab.name
                if (choice === 'projectContent') {
                    this.showProjectContent = true
                    this.showProjectSettings = false
                } else {
                    this.showProjectContent = false
                    this.showProjectSettings = true
                }
            },
            handleMessage(e) {
                window.location.href = './workspace.html'
            },
            downloadProject(){

            },
            getLatestProjectChangeImf() {
                console.log(this.selectedProject.projectId)
                axios.get('/project/changeImf', {params: {'projectId': this.selectedProject.projectId}})
                    .then(results => {
                        if (results.data.code === 20000) {
                            this.latestProjectChangeImf = results.data.data
                        } else {
                            this.$message.warning("工程更新信息异常")
                            this.showProjectList = false
                        }
                    })
            },
            checkProject(project) {
                this.hideAll()
                this.showProject = true
                this.selectedProject = project
                this.getLatestProjectChangeImf()
            },
            handleSelect(key) {
                this.hideAll();
                if (key === 'depot') {
                    this.showDepot = true
                    this.getAllProject()
                } else if (key === 'myLike') {
                    this.showMyLike = true
                } else if (key === 'addProject') {
                    this.showAddProject = true
                }
            },
            handleClick(key) {
                if (key === 'all') {
                    this.getAllProject()
                } else if (key === 'ownPro') {
                    this.getOwnProject()
                } else if (key === 'joinPro') {
                    this.getJoinProject()
                } else if (key === 'publicFirst' || key === 'privateFirst' ||
                            key === 'latestFirst' || key === 'reverse'){
                    this.projectList = sortProject(key, this.projectList)
                }
            },
            setProjectList(result){
                console.log(result)
                if (result.data.code === 20000) {
                    this.projectList = result.data.data
                    this.showProjectList = true
                } else {
                    this.showProjectList = false
                }
            },
            getAllProject() {
                axios.get('/project/all').then(results => {
                    this.setProjectList(results)
                })
            },
            getOwnProject() {
                axios.get('/project/own').then(results => {
                    this.setProjectList(results)
                })
            },
            getJoinProject() {
                axios.get('/project/join').then(results => {
                    this.setProjectList(results)
                })
            },
            hideAll() {
                this.showDepot = false
                this.showAddProject = false
                this.showMyLike = false
                this.showProject = false
            },

        }
    })
</script>

<style scoped>


</style>
</body>
</html>